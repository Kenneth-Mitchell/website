<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta property="og:title" content="Test Article | Kenneth Mitchell" />
  <meta property="og:description" content="A test article." />
  <link rel="icon" href="../favicon.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="../style.css" />
  <title>Test Article | Kenneth Mitchell</title>
  <style>
    h1 {
      font-size: 18px;
      margin-bottom: 8px;
    }
    .comments {
      margin-top: 64px;
      padding-top: 32px;
      border-top: 1px solid var(--border);
    }
    .comments h2 {
      font-size: 14px;
      font-weight: normal;
      color: var(--text-muted);
      margin-bottom: 24px;
    }
    /* Comment Form */
    .comment-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 32px;
    }
    .comment-form input,
    .comment-form textarea {
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 12px;
      font-family: inherit;
      font-size: 13px;
      transition: border-color 0.2s;
    }
    .comment-form input:focus,
    .comment-form textarea:focus {
      outline: none;
      border-color: var(--text-muted);
    }
    .comment-form textarea {
      min-height: 100px;
      resize: vertical;
    }
    .comment-form button {
      align-self: flex-start;
      background: var(--text);
      color: var(--bg);
      border: none;
      padding: 8px 16px;
      font-family: inherit;
      font-size: 13px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .comment-form button:hover {
      opacity: 0.8;
    }
    .comment-form button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .form-status {
      font-size: 12px;
      color: var(--text-muted);
    }
    .form-status.success { color: #6a9955; }
    .form-status.error { color: #f14c4c; }
    /* Comments List */
    .comments-list {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .comment {
      border-left: 2px solid var(--border);
      padding-left: 16px;
    }
    .comment-header {
      display: flex;
      gap: 12px;
      margin-bottom: 8px;
    }
    .comment-author {
      color: var(--text);
      font-size: 13px;
    }
    .comment-date {
      color: var(--text-dim);
      font-size: 12px;
    }
    .comment-content {
      color: var(--text-muted);
      font-size: 13px;
      line-height: 1.6;
    }
    .no-comments, .loading {
      color: var(--text-dim);
      font-size: 13px;
    }
    /* Nested replies */
    .comment-replies {
      margin-top: 16px;
      margin-left: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .reply-btn {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 12px;
      cursor: pointer;
      padding: 0;
      margin-top: 8px;
    }
    .reply-btn:hover {
      color: var(--text-muted);
    }
    .comment-form.replying {
      margin-left: 16px;
      margin-top: 12px;
      padding-left: 16px;
      border-left: 2px solid var(--border);
    }
    .cancel-reply {
      background: none;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 8px 16px;
      font-family: inherit;
      font-size: 13px;
      cursor: pointer;
      margin-left: 8px;
    }
  </style>
</head>
<body class="pre-decode">
  <div class="header">
    <div class="path" data-decode><a href="../index.html">kenneth</a> / <a href="../thoughts.html">thoughts</a></div>
    <h1 data-decode>Test Article</h1>
    <div class="date" data-decode>Dec 2024</div>
  </div>
  <article>
    <p>
      Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
    </p>
  </article>

  <!-- Comments Section -->
  <section class="comments">
    <h2 data-decode>Comments</h2>
    
    <!-- Comment Form -->
    <form id="comment-form" class="comment-form">
      <input type="text" name="nickname" placeholder="Name" required />
      <textarea name="content" placeholder="Your comment..." required></textarea>
      <button type="submit">Submit</button>
      <div class="form-status"></div>
    </form>
    
    <!-- Comments List -->
    <div id="comments-list" class="comments-list">
      <div class="loading">Loading comments...</div>
    </div>
  </section>

  <script>
    const CUSDIS_APP_ID = 'c99591e9-8cd1-4134-8a4b-3916b0c6e9c6';
    const PAGE_ID = 'test-article';
    const PAGE_URL = 'https://kenneth-mitchell.com/thought/bioxai.html';
    const PAGE_TITLE = 'Test Article';
    
    let replyingTo = null;

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function renderComment(c) {
      const repliesData = c.replies && c.replies.data && c.replies.data.length > 0 
        ? `<div class="comment-replies">${c.replies.data.map(r => renderComment(r)).join('')}</div>`
        : '';
      
      return `
        <div class="comment" data-id="${c.id}">
          <div class="comment-header">
            <span class="comment-author">${escapeHtml(c.by_nickname)}</span>
            <span class="comment-date">${new Date(c.createdAt).toLocaleDateString()}</span>
          </div>
          <div class="comment-content">${escapeHtml(c.content)}</div>
          <button class="reply-btn" onclick="startReply('${c.id}', '${escapeHtml(c.by_nickname)}')">Reply</button>
          ${repliesData}
        </div>
      `;
    }

    async function fetchComments() {
      const list = document.getElementById('comments-list');
      try {
        const res = await fetch(`https://cusdis.com/api/open/comments?appId=${CUSDIS_APP_ID}&pageId=${PAGE_ID}`);
        const json = await res.json();
        const comments = json.data?.data || [];
        
        if (comments.length > 0) {
          list.innerHTML = comments.map(c => renderComment(c)).join('');
        } else {
          list.innerHTML = '<div class="no-comments">No comments yet.</div>';
        }
      } catch (e) {
        list.innerHTML = '<div class="no-comments">No comments yet.</div>';
      }
    }

    function startReply(commentId, authorName) {
      replyingTo = commentId;
      const form = document.getElementById('comment-form');
      form.classList.add('replying');
      form.querySelector('textarea').placeholder = `Replying to ${authorName}...`;
      form.querySelector('textarea').focus();
      
      // Add cancel button if not exists
      if (!form.querySelector('.cancel-reply')) {
        const cancelBtn = document.createElement('button');
        cancelBtn.type = 'button';
        cancelBtn.className = 'cancel-reply';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.onclick = cancelReply;
        form.querySelector('button[type="submit"]').after(cancelBtn);
      }
    }

    function cancelReply() {
      replyingTo = null;
      const form = document.getElementById('comment-form');
      form.classList.remove('replying');
      form.querySelector('textarea').placeholder = 'Your comment...';
      const cancelBtn = form.querySelector('.cancel-reply');
      if (cancelBtn) cancelBtn.remove();
    }

    document.getElementById('comment-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const status = form.querySelector('.form-status');
      const btn = form.querySelector('button[type="submit"]');
      
      btn.disabled = true;
      btn.textContent = 'Submitting...';
      
      try {
        const payload = {
          appId: CUSDIS_APP_ID,
          pageId: PAGE_ID,
          pageUrl: PAGE_URL,
          pageTitle: PAGE_TITLE,
          nickname: form.nickname.value,
          content: form.content.value
        };
        
        if (replyingTo) {
          payload.parentId = replyingTo;
        }
        
        const res = await fetch('https://cusdis.com/api/open/comments', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        if (res.ok) {
          status.textContent = 'Submitted. May take a moment to appear.';
          status.className = 'form-status success';
          form.reset();
          cancelReply();
        } else {
          throw new Error('Failed');
        }
      } catch (e) {
        status.textContent = 'Failed to submit. Try again.';
        status.className = 'form-status error';
      }
      
      btn.disabled = false;
      btn.textContent = 'Submit';
    });

    fetchComments();
  </script>

  <script src="../decode.js"></script>
</body>
</html>
